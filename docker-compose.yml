version: '3.8'

services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: pulse-broker
    # Each command argument is its own list item for maximum stability
    command:
      - redpanda
      - start
      - --smp
      - "1"
      - --memory
      - 1G
      - --overprovisioned
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"

  console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: pulse-console
    ports:
      - "8080:8080"
    environment:
      # This replaces the complex 'command' and 'echo' logic
      KAFKA_BROKERS: "redpanda:9092"
    depends_on:
      - redpanda

  clickhouse:
    image: clickhouse/clickhouse-server
    container_name: pulse-clickhouse
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=password  # Set this to something simple like 'admin'
    ports:
      - "8123:8123"
      - "9000:9000"

  grafana:
    image: grafana/grafana-oss
    container_name: pulse-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    depends_on:
      - clickhouse